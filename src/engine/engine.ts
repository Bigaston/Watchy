import { LuaEngine, LuaFactory } from "wasmoon";
import * as PIXI from "pixi.js";
import { WGameDescription } from "../share/types";
import { initInput, stopInput, updateGamepad } from "./input";
import { initDisplay, stopDisplay } from "./display";
import { _isPaused, initSystem } from "./system";
import { initSound } from "./sound";

const factory = new LuaFactory();

let backgroundImage = `data:image/png;base64,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AAAAxBA8AQAAAIAYgicAAAAAEEPwBAAAAABiCJ4AAAAAQAzBEwAAAACIIXgCAAAAADEETwAAAAAghuAJAAAAAMQQPAEAAACAGIInAAAAABBD8AQAAAAAYgieAAAAAEAMwRMAAAAAiCF4AgAAAAAxBE8AAAAAIIbgCQAAAADEEDwBAAAAgBiCJwAAAAAQQ/AEAAAAAGIIngAAAABADMETAAAAAIgheAIAAAAAMQRPAAAAACCG4AkAAAAAxBA8AQAAAIAYgicAAAAAEEPwBAAAAABiCJ4AAAAAQAzBEwAAAACIIXgCAAAAADEETwAAAAAghuAJAAAAAMQQPAEAAACAGIInAAAAABBD8AQAAAAAYgieAAAAAEAMwRMAAAAAiCF4AgAAAAAxBE8AAAAAIIbgCQAAAADEEDwBAAAAgBiCJwAAAAAQQ/AEAAAAAGIIngAAAABADMETAAAAAIgheAIAAAAAMQRPAAAAACCG4AkAAAAAxBA8AQAAAIAYgicAAAAAEEPwBAAAAABiCJ4AAAAAQAzBEwAAAACIIXgCAAAAADEETwAAAAAghuAJAAAAAMQQPAEAAACAGIInAAAAABBD8AQAAAAAYgieAAAAAEAMwRMAAAAAiCF4AgAAAAAxBE8AAAAAIIbgCQAAAADEEDwBAAAAgBiCJwAAAAAQQ/AEAAAAAGIIngAAAABADMETAAAAAIgheAIAAAAAMQRPAAAAACCG4AkAAAAAxBA8AQAAAIAYgicAAAAAEEPwBAAAAABiCJ4AAAAAQAzBEwAAAACIIXgCAAAAADEETwAAAAAghuAJAAAAAMQQPAEAAACAGIInAAAAABBD8AQAAAAAYgieAAAAAEAMwRMAAAAAiCF4AgAAAAAxBE8AAAAAIIbgCQAAAADEEDwBAAAAgBiCJwAAAAAQQ/AEAAAAAGIIngAAAABADMETAAAAAIgheAIAAAAAMQRPAAAAACCG4AkAAAAAxBA8AQAAAIAYgicAAAAAEEPwBAAAAABiCJ4AAAAAQAzBEwAAAACIIXgCAAAAADEETwAAAAAghuAJAAAAAMQQPAEAAACAGIInAAAAABBD8AQAAAAAYgieAAAAAEAMwRMAAAAAiCF4AgAAAAAxBE8AAAAAIIbgCQAAAADEEDwBAAAAgBiCJwAAAAAQQ/AEAAAAAGIIngAAAABADMETAAAAAIgheAIAAAAAMQRPAAAAACCG4AkAAAAAxBA8AQAAAIAYgicAAAAAEEPwBAAAAABiCJ4AAAAAQAzBEwAAAACIIXgCAAAAADEETwAAAAAghuAJAAAAAMQQPAEAAACAGIInAAAAABBD8AQAAAAAYgieAAAAAEAMwRMAAAAAiCF4AgAAAAAxBE8AAAAAIIbgCQAAAADEEDwBAAAAgBiCJwAAAAAQQ/AEAAAAAGIIngAAAABADMETAAAAAIgheAIAAAAAMQRPAAAAACCG4AkAAAAAxBA8AQAAAIAYgicAAAAAEEPwBAAAAABiCJ4AAAAAQAzBEwAAAACIIXgCAAAAADEETwAAAAAghuAJAAAAAMQQPAEAAACAGIInAAAAABBD8AQAAAAAYgieAAAAAEAMwRMAAAAAiCF4AgAAAAAxBE8AAAAAIIbgCQAAAADEEDwBAAAAgBiCJwAAAAAQQ/AEAAAAAGIIngAAAABADMETAAAAAIgheAIAAAAAMQRPAAAAACCG4AkAAAAAxBA8AQAAAIAYgicAAAAAEEPwBAAAAABiCJ4AAAAAQAzBEwAAAACIIXgCAAAAADEETwAAAAAghuAJAAAAAMQQPAEAAACAGIInAAAAABBD8AQAAAAAYgieAAAAAEAMwRMAAAAAiCF4AgAAAAAxBE8AAAAAIIbgCQAAAADEEDwBAAAAgBiCJwAAAAAQQ/AEAAAAAGIIngAAAABADMETAAAAAIgheAIAAAAAMQRPAAAAACCG4AkAAAAAxBA8AQAAAIAYgicAAAAAEEPwBAAAAABiCJ4AAAAAQAzBEwAAAACIIXgCAAAAADEETwAAAAAghuAJAAAAAMQQPAEAAACAGIInAAAAABBD8AQAAAAAYgieAAAAAEAMwRMAAAAAiCF4AgAAAAAxBE8AAAAAIIbgCQAAAADEEDwBAAAAgBiCJwAAAAAQQ/AEAAAAAGIIngAAAABADMETAAAAAIgheAIAAAAAMQRPAAAAACCG4AkAAAAAxBA8AQAAAIAYgicAAAAAEEPwBAAAAABiCJ4AAAAAQAzBEwAAAACIIXgCAAAAADEETwAAAAAghuAJAAAAAMQQPAEAAACAGIInAAAAABBD8AQAAAAAYgieAAAAAEAMwRMAAAAAiCF4AgAAAAAxBE8AAAAAIIbgCQAAAADEEDwBAAAAgBiCJwAAAAAQQ/AEAAAAAGIIngAA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`;

const embedWidth = 900;
const embedHeight = 600;

const normalWidth = 1340;
const normalHeight = 700;

let width = normalWidth;
let height = normalHeight;

let hasBeenInitialized = false;

let lua: LuaEngine;
let app: PIXI.Application;
let renderElement: HTMLElement;

let gameFunction: { [key: string]: undefined | Function } = {
  init: undefined,
  update: undefined,
  gameUpdate: undefined,
  draw: undefined,
};

export async function initEngine(
  gameDescription: WGameDescription,
  _renderElement: HTMLElement,
  embed: boolean = false
) {
  lua = await factory.createEngine();
  renderElement = _renderElement;

  width = embed ? embedWidth : normalWidth;
  height = embed ? embedHeight : normalHeight;

  // PIXIJS
  app = new PIXI.Application({
    width: width,
    height: height,
    background: 0xedb4a1,
    resolution: window.devicePixelRatio || 1,
    autoDensity: true,
  });

  renderElement.appendChild(app.view as any as Node);

  window.addEventListener("resize", resize);
  resize();

  // Init game&watch element
  if (!embed) {
    let gameWatchSprite = new PIXI.Sprite(PIXI.Texture.from(backgroundImage));
    gameWatchSprite.width = width;
    gameWatchSprite.height = height;

    app.stage.addChild(gameWatchSprite);
  }

  // Game Container
  let gameContainer = new PIXI.Container();
  gameContainer.width = normalWidth;
  gameContainer.height = normalHeight;

  if (!embed) {
    gameContainer.x = (width - embedWidth) / 2;
    gameContainer.y = (height - embedHeight) / 2;
  }

  app.stage.addChild(gameContainer);

  // Init Game Background
  let background = new PIXI.Sprite(
    gameDescription.background
      ? PIXI.Texture.from(gameDescription.background)
      : PIXI.Texture.EMPTY
  );
  background.width = width;
  background.height = height;

  gameContainer.addChild(background);

  let functionObject = {};

  initInput(functionObject);
  initDisplay(gameContainer, gameDescription, functionObject);
  initSystem(lua, functionObject);
  initSound(functionObject, gameDescription);

  lua.global.set("watchy", functionObject);

  // Execute Lua Code
  await lua.doString(gameDescription.code);

  // Get the three main functions we need here in TypeScript
  let watchy = lua.global.get("watchy");

  gameFunction.init = watchy.init;
  gameFunction.update = watchy.update;
  gameFunction.gameUpdate = watchy.gameUpdate;
  gameFunction.draw = watchy.draw;

  // If init is a function, call it
  if (gameFunction.init != null && typeof gameFunction.init === "function") {
    gameFunction.init();
  }

  app.ticker.add(ticker);

  hasBeenInitialized = true;

  if (!embed) {
    document.title = gameDescription.title + " - Watchy";
  }
}

function ticker(delta: number) {
  updateGamepad();

  if (gameFunction.update) gameFunction.update(delta);

  if (!_isPaused) {
    if (gameFunction.gameUpdate) gameFunction.gameUpdate(delta);
  }

  if (gameFunction.draw) gameFunction.draw();
}

export function stopEngine() {
  if (!hasBeenInitialized) return;

  app.ticker.remove(ticker);
  app.destroy();

  lua.global.close();

  stopDisplay();
  stopInput();

  window.removeEventListener("resize", resize);

  renderElement.innerHTML = "";

  gameFunction = {
    init: undefined,
    update: undefined,
    gameUpdate: undefined,
    draw: undefined,
  };

  hasBeenInitialized = false;
}

export function resize() {
  // current screen size
  const screenWidth = renderElement.clientWidth;
  const screenHeight = renderElement.clientHeight;

  // uniform scale for our game
  const scale = Math.min(screenWidth / width, screenHeight / height);

  // the "uniformly englarged" size for our game
  const enlargedWidth = Math.floor(scale * width);
  const enlargedHeight = Math.floor(scale * height);

  // margins for centering our game
  const horizontalMargin = (screenWidth - enlargedWidth) / 2;
  const verticalMargin = (screenHeight - enlargedHeight) / 2;

  // now we use css trickery to set the sizes and margins
  app.view.style!.width = `${enlargedWidth}px`;
  app.view.style!.height = `${enlargedHeight}px`;
  (app.view as unknown as HTMLCanvasElement).style.marginLeft = (
    app.view as unknown as HTMLCanvasElement
  ).style.marginRight = `${horizontalMargin}px`;
  (app.view as unknown as HTMLCanvasElement).style.marginTop = (
    app.view as unknown as HTMLCanvasElement
  ).style.marginBottom = `${verticalMargin}px`;
}
